name: "Build Java Application"
on:
  workflow_call:
    inputs:
      java-version:  
        description: 'java version'
        type: string
        default: '11'
        required: false
      app-version:
        description: 'apps version'
        type: string
        required: true
        default: '1'
      app-name:
        description: 'apps version'
        type: string
        required: true
      nfs-server-path:
        description: 'nfs path for app'
        type: string
        required: true
      nfs-mount-path:
        description: 'nfs mount path for app'
        type: string
        required: true
      xms:
        description: 'java xms'
        type: string
        default: "128m"
        required: true
      xmx:
        description: 'java xmx'
        default: "256m"
        type: string
        required: true
      host:
        type: string
        required: true
      username:
        type: string
        required: true
    secrets:
      gcloud-key:
        required: true

jobs:
  build_job:
    name: Build java
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          java-version: "11"
          distribution: "adopt"
          cache: maven
      - run: mvn --batch-mode --update-snapshots verify
        shell: bash
      - run: mkdir ${{ inputs.app-name }} && cp target/*.jar ${{ inputs.app-name }}/${{ inputs.app-name }}-v${{ inputs.app-version }}.jar
        shell: bash
      - uses: actions/upload-artifact@v2
        with:
          name: Package
          path: ${{ inputs.app-name }}
      - run: |
          echo "FROM openjdk:11-jre-slim 
          RUN mkdir -p /app/config ${{inputs.nfs-mount-path}}
          COPY ${{ inputs.app-name }}/${{ inputs.app-name }}-v${{ inputs.app-version }}.jar /app
          COPY properties/application.properties /app/config
          RUN chown -R 3002. /app
          USER 3002
          EXPOSE 8080 
          ENTRYPOINT ["java","-server","-Xms${{inputs.xms}}", "-Xmx${{inputs.xmx}}","-jar","/app/${{ inputs.app-name }}-v${{ inputs.app-version }}.jar","-Dspring.config.location=/app/config/application.properties"]" > Dockerfile
        shell: bash
      - run: |
          cat Dockerfile
        shell: bash
      
      # Push to GCR
      - name: Login to gcloud registry
        id: gcloud
        uses: elgohr/gcloud-login-action@master
        with:
          account_key: ${{ secrets.gcloud-key }}
      - name: Publish to Registry
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ inputs.app-name }}
          username: ${{ steps.gcloud.outputs.username }}
          password: ${{ steps.gcloud.outputs.password }}
          dockerfile: Dockerfile
          tags: ${{ inputs.app-version }}
          registry: asia.gcr.io/rise-prod-327008
      - uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.HOST }}
          username: ${{ inputs.USERNAME }}
          script: |
            docker run \
            --volume-driver=nfs \
            -v ${{ inputs.nfs-server-path }}:${{ inputs.nfs-mount-path }}\
            asia.gcr.io/rise-prod-327008/${{ inputs.app-name }}:${{ inputs.app-version }}
